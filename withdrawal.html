<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdrawal Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h3{
            Font-size: 16px;
            Text-align: center;
        }
        .container {
            background: #fff;
            width: 87%;
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            text-align: center;
            color: #333;
        }
        .user-info {
            text-align: center;
            margin-bottom: 20px;
        }
        .user-info h2 {
            margin: 5px 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
        }
        input, select {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            background-color: #28a745;
            color: #fff;
            padding: 10px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        
        /* Loading Screen */
#loadingScreen {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
}

#loadingScreen span {
    animation: spin 1s linear infinite;
    border: 7px solid white;
    border-top: 7px solid #00796B;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: inline-block;
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

footer {
    text-align: center;
    background-color: #00796B;
    color: #ecf0f1;
    padding: 20px;
    font-size: 1rem;
    border-top: 3px solid rgba(255, 255, 255, 0.1);
}
        .table-container {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            font-size: 7px;
        }
        th {
            background-color: #f8f9fa;
        }
        
        .container7 {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 2px;
            max-width: 400px;
            text-align: center;
        }
        .container h {
            
            color: #333;
            margin-bottom: 15px;
            
        }
        .container7 p {
            font-size: 10px;
            color: #555;
            Font-weight: bold;
            line-height: 1.6;
        }
        .menu {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        .menu a {
            text-decoration: none;
        }
        .menu img {
            width: 100px;
            height: 100px;
            transition: transform 0.2s ease-in-out;
        }
        .menu img:hover {
            transform: scale(1.1);
        }
        
        header {
            background-color: #00796B;
            color: #fff;
            padding: 1rem;
            text-align: center;
        }
    </style>
    
    
    <style>
    #email-icon {
            position: fixed;
            bottom: 20px;
            right: 2px;
            width: 70px;
            height: 70px;
            Top: 220px;
            
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        #email-icon:hover {
            transform: scale(1.1);
        }

        #email-icon img {
            width: 70px;
            height: 70px;
            Border-radius: 50%;
        }
             
</style>
<style>
        
        .container {
            width: 85%;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #95ffe091;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn {
            display: inline-block;
            padding: 12px 20px;
            font-size: 12px;
            Font-weight: bold;
            background-color: #00796B;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .btn:hover {
            background-color: #004d40;
        }

        .history-container {
            background-color: #f4f4f4;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-height: 500px;
            overflow-y: auto;
            display: none;
        }

        .transaction {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .transaction p {
            margin: 5px 0;
            font-size: 9px;
            color: #333;
        }

        .transaction p strong {
            font-weight: bold;
            color: #2c3e50;
        }

        .transaction hr {
            margin-top: 10px;
            border: 0;
            border-top: 1px solid #eee;
        }
    </style>
    <style>       
        .container7 {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 2px;
            max-width: 400px;
            text-align: center;
        }
        .container h {
            
            color: #333;
            margin-bottom: 15px;
            
        }
        .container7 p {
            font-size: 10px;
            color: #555;
            Font-weight: bold;
            line-height: 1.6;
        }
        .menu {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        .menu a {
            text-decoration: none;
        }
        .menu img {
            width: 100px;
            height: 100px;
            transition: transform 0.2s ease-in-out;
        }
        .menu img:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
       <style>        
                #whatsapp-icon {
            position: fixed;
            bottom: 20px;
            right: 0px;
            Top: 300px;
            width: 60px;
            height: 60px;
            animation: motion 3s infinite;
            z-index: 9999;
        }

        #whatsapp-icon img {
            width: 100%;
            height: 100%;
        }

        /* Animation */
        @keyframes motion {
            0% {
                transform: translateY(0);
            }
            10% {
                transform: translateY(-10px);
            }
            20% {
                transform: translateY(10px);
            }
            30% {
                transform: translateY(0);
            }
            40% {
                transform: translateX(10px);
            }
            50% {
                transform: translateX(-10px);
            }
            60% {
                transform: translateX(0);
            }
            70% {
                transform: scale(1.1);
            }
            80% {
                transform: scale(1.3);
            }
            100% {
                transform: scale(1);
            }
        }
    </style> 
        <a href="Adminchat.html" target="_blank" id="whatsapp-icon">
        <img src="whatsapp.png" alt="WhatsApp" />
    </a>

    <div id="email-icon">
    <img src="sup.png" alt="Support Icon">
</div>

<script>
    document.getElementById('email-icon').addEventListener('click', function () {
        const email = 'agrofruitenterprises@gmail.com';
        const subject = encodeURIComponent("Customer Inquiry from AgroFruit Invest");
        const body = encodeURIComponent("Dear AgroFruit,\n\nI have questions regarding your services. Please assist.\n\nThank you.");
        const mailtoUrl = `mailto:${email}?subject=${subject}&body=${body}`;
        window.location.href = mailtoUrl;
    });
</script>
     <div id="loadingScreen">
            <span></span>
        </div>
        <header>
        <h4>Welcome To Your AFE Transfer Page</h4>
       <span> <img src="wi.png" style="width: 50px; height: 50%;"></span><i>Bank Transfer 7% Network fee, </i>
    </header>
    
        <div class="container7">
        <h>Withdrawal Information</h>
        <p>
            Minimum withdrawal: ₦500.<br>
            Maximum withdrawal: ₦100,000 daily.<br><br>            Withdrawals will be credited to your bank account within 4 to 24 hours. This timeframe ensures compliance with CBN and SEC regulations, as well as international financial standards.<br><br>
            If your withdrawal remains pending for more than Over 24 hours, please contact AgroFruit Enterprises (AFE) For Nigeria Customer Care for assistance.
        </p>
        <div class="menu">
            <a href="Adminchat.html" target="_blank">
                <img src="whatsapp.png" alt="WhatsApp">
                Chat 
            </a>
            <a href="mailto:agrofruitenterprises@gmail.com" target="_blank">
                Email 
                <img src="email.png" alt="Email">
            </a>
            <a href="https://t.me/+2348166836059" target="_blank">
                <img src="call1.png" alt="Call">  Telegram              
            </a>
        </div>
    </div>  
      
    <div class="container">
        <div class="user-info">
            <h2>Hi <span id="userName"></span>,👋</h2>
            <h3>Balance: ₦<span id="userBalance">0.00</span></h3>
        </div>
        <form id="withdrawalForm">
            <div class="form-group">
                <label for="amount">Amount</label>
                <input type="number" id="amount" placeholder="Enter amount" required>
            </div>
            <div class="form-group">
                <label for="accountNumber">Account Number</label>
                <input type="text" id="accountNumber" placeholder="Enter account number" required>
            </div>
            <div class="form-group">
                <label for="bankName">Select Bank Name</label>
                <select id="bankName" required>
                    <option value="" disabled selected>Select a bank</option>                   
<option value="063">Access Bank</option>
<option value="801">Abbey Mortgage Bank</option>
<option value="023">Citibank Nigeria</option>
<option value="559">Coronation Merchant Bank</option>
<option value="063">Access Bank (Diamond)</option>
<option value="050">Ecobank</option>
<option value="070">Fidelity Bank</option>
<option value="011">First Bank</option>
<option value="214">FCMB</option>
<option value="501">FSDH Merchant Bank Limited</option>
<option value="00103">Globus Bank</option>
<option value="058">GTBank</option>
<option value="030">Heritage Bank</option>
<option value="301">Jaiz Bank</option>
<option value="50211">Kuda Bank</option>
<option value="082">Keystone Bank</option>
<option value="303">Lotus Bank</option>
<option value="100004">OPay</option>
<option value="50515">Moniepoint MFB</option>
<option value="526">Parallex Bank</option>
<option value="999991">PalmPay</option>
<option value="101">Providus Bank</option>
<option value="125">Rubies MFB</option>
<option value="068">Standard Chartered Bank</option>
<option value="232">Sterling Bank</option>
<option value="100">SunTrust Bank</option>
<option value="221">Stanbic IBTC Bank</option>
<option value="068">Standard Chartered Bank</option>
<option value="102">Titan Trust Bank</option>
<option value="032">Union Bank</option>
<option value="033">UBA</option>
<option value="215">Unity Bank</option>
<option value="035">Wema Bank</option>
<option value="057">Zenith Bank</option>

                </select>
            </div>
            <button type="submit" id="withdrawButton">Submit</button>
        </form>
       
        <div class="table-container">
            <h3>Pending Withdrawals</h3>
            <table>
                <thead>
                    <tr>
                        <th>Amount</th>
                        <th>Account Number</th>
                        <th>Account Name</th>
                        <th>Bank Name</th>
                        <th>Date & Time</th>
                    </tr>
                </thead>
                <tbody id="pendingWithdrawals"></tbody>
            </table>
        </div>
        <div class="table-container">
            <h3>Successful Withdrawals</h3>
            <table>
                <thead>
                    <tr>
                        <th>Amount</th>
                        <th>Account Number</th>
                        <th>Account Name</th>
                        <th>Bank Name</th>
                        <th>Date & Time</th>
                    </tr>
                </thead>
                <tbody id="successfulWithdrawals"></tbody>
            </table>
        </div>
    </div>
    <footer>
        <p>&copy; AgroFruit. All rights reserved.</p>
    </footer>
    <script type="module">                  
         import { app, analytics, firebaseConfig } from './firebase.js';
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

const auth = getAuth(app);
const db = getDatabase(app);

// DOM Elements
const userName = document.getElementById("userName");
const userBalance = document.getElementById("userBalance");
const withdrawalForm = document.getElementById("withdrawalForm");
const loadingScreen = document.getElementById("loadingScreen");
const pendingWithdrawalsTable = document.getElementById("pendingWithdrawals");
const successfulWithdrawalsTable = document.getElementById("successfulWithdrawals");


// Show Loading Screen
function showLoading() {
    loadingScreen.style.display = "flex";
}

// Hide Loading Screen
function hideLoading() {
    loadingScreen.style.display = "none";
}

// Fetch User Data
async function fetchUserData(uid) {
    const userRef = ref(db, `users/${uid}`);
    const snapshot = await get(userRef);
    if (snapshot.exists()) {
        const data = snapshot.val();
        userName.textContent = data.fullName || "User";
        userBalance.textContent = data.userBalance || "0.00";
        return data;
    } else {
        throw new Error("User data not found.");
    }
}

// Function to fetch pending withdrawals
async function fetchPendingWithdrawals(uid) {
    const pendingRef = ref(db, `users/${uid}/withdrawalPending`);
    const pendingSnapshot = await get(pendingRef);

    if (pendingSnapshot.exists()) {
        const pendingData = pendingSnapshot.val();
        pendingWithdrawalsTable.innerHTML = `
            <tr>
                <td>₦${pendingData.amount.toFixed(2)}</td>
                <td>${pendingData.accountNumber}</td>
                <td>${pendingData.accountName}</td>
                <td>${pendingData.bankName}</td>
                <td>${pendingData.date}</td>
            </tr>
        `;
    } else {
        pendingWithdrawalsTable.innerHTML = `
            <tr>
                <td colspan="5">No pending withdrawals found.</td>
            </tr>
        `;
    }
}

// Function to fetch successful withdrawals
async function fetchSuccessfulWithdrawals(uid) {
    const successfulRef = ref(db, `users/${uid}/withdrawalSuccessful`);
    const successfulSnapshot = await get(successfulRef);

    if (successfulSnapshot.exists()) {
        const successfulData = Object.values(successfulSnapshot.val());
        successfulWithdrawalsTable.innerHTML = successfulData
            .map(
                (data) => `
            <tr>
                <td>₦${data.amount.toFixed(2)}</td>
                <td>${data.accountNumber}</td>
                <td>${data.accountName}</td>
                <td>${data.bankName}</td>
                <td>${data.date}</td>
            </tr>
        `
            )
            .join("");
    } else {
        successfulWithdrawalsTable.innerHTML = `
            <tr>
                <td colspan="5">No successful withdrawals found.</td>
            </tr>
        `;
    }
}

// Add Pending Withdrawal
async function addPendingWithdrawal(uid, withdrawalData) {
    const pendingRef = ref(db, `users/${uid}/withdrawalPending`);
    await set(pendingRef, withdrawalData);
}

// Handle Withdrawal Form Submission
withdrawalForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    showLoading();

    const amount = parseFloat(document.getElementById("amount").value);
    const accountNumber = document.getElementById("accountNumber").value;
    const bankSelect = document.getElementById("bankName");
    const bankCode = bankSelect.value;
    const bankName = bankSelect.options[bankSelect.selectedIndex].text;

    if (amount < 500 || amount > 100000) {
        alert("The minimum withdrawal amount is ₦500, while the maximum is ₦100,000 per day.");
        hideLoading();
        return;
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            try {
                const userData = await fetchUserData(user.uid);
                if (parseFloat(userData.userBalance || 0) < amount) {
                    alert("Insufficient balance.");
                    hideLoading();
                    return;
                }

                const pendingRef = ref(db, `users/${user.uid}/withdrawalPending`);
                const pendingSnapshot = await get(pendingRef);
                if (pendingSnapshot.exists()) {
                    const pendingData = pendingSnapshot.val();
                    alert(
                        `You already have a pending withdrawal of ₦${pendingData.amount}. Please wait per for 4 to 24 hours.`
                    );
                    hideLoading();
                    return;
                }



               // Verification using Monnify
                const apiKey = "MK_TEST_7FBWHU9H7U";
                const secretKey = "YJV0GE4LT2B1WE4FD4H5XY4ZU6WC2VVJ";
                const authToken = btoa(`${apiKey}:${secretKey}`);

                const tokenResponse = await fetch(
                    "https://api.monnify.com/api/v1/auth/login",
                    {
                        method: "POST",
                        headers: {
                            Authorization: `Basic ${authToken}`,
                            "Content-Type": "application/json",
                        },
                    }
                );
                const tokenData = await tokenResponse.json();

                if (tokenData.requestSuccessful) {
                    const accessToken = tokenData.responseBody.accessToken;
                    const validateResponse = await fetch(
                        `https://api.monnify.com/api/v1/disbursements/account/validate?accountNumber=${accountNumber}&bankCode=${bankCode}`,
                        {
                            method: "GET",
                            headers: {
                                Authorization: `Bearer ${accessToken}`,
                                "Content-Type": "application/json",
                            },
                        }
                    );
                    const validateData = await validateResponse.json();

                    if (validateData.requestSuccessful) {
                        const accountName = validateData.responseBody.accountName;
                        const confirmTransfer = confirm(
                            `Are you sure you want to withdraw ₦${amount} to ${accountName} ${bankName} ${accountNumber}?`
                        );
                        if (!confirmTransfer) {
                            hideLoading();
                            return;
                        }

                        const userPin = prompt("Enter your 5-digit Transfer PIN:");
                        if (!userPin || userPin !== userData.transferP) {
                            alert("Incorrect PIN. Please try again.");
                            hideLoading();
                            return;
                        }

                        const netAmount = amount - amount * 0.07;
                        const withdrawalData = {
                            amount: netAmount,
                            bankCode,
                            accountNumber,
                            bankName,
                            accountName,
                            date: new Date().toLocaleString("en-NG"),
                        };

                        await addPendingWithdrawal(user.uid, withdrawalData);

                        alert(
                            "Withdrawal request submitted successfully. Pending approval. You will be paid within 4 to 24 hours."
                        );
                        hideLoading();
                    } else {
                        alert(`Error: ${validateData.responseMessage}`);
                        hideLoading();
                    }
                } else {
                    alert("Error authenticating with Monnify.");
                    hideLoading();
                }
            } catch (error) {
                alert(error.message);
                hideLoading();
            }
        } else {
            alert("User not authenticated.");
            hideLoading();
        }
    });
});
   

// Initialize App
onAuthStateChanged(auth, async (user) => {
    if (user) {
        try {
            
            await Promise.all([
                fetchPendingWithdrawals(user.uid),
                fetchSuccessfulWithdrawals(user.uid),
                fetchUserData(user.uid)
            ]);
        } catch (error) {
            console.error("Error fetching data:", error);
            alert(error.message); 
        }
    } else {
        alert("No user signed in.");
    }
});

document.addEventListener("DOMContentLoaded", () => {
    showLoading();
    setTimeout(() => {
        hideLoading();
    }, 3000); 
});
                    
    </script>
</body>
</html>
