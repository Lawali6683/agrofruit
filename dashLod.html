<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Optimized Loading Screen</title>
  <style>
    #loadingScreen {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #loadingScreen span {
        animation: spin 1s linear infinite;
        border: 7px solid white;
        border-top: 7px solid #00796B;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: inline-block;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div id="loadingScreen">
        <span></span>  
              
  </div>
  <script type="module">
    import { app, analytics, firebaseConfig } from './firebase.js';
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const db = getDatabase(app);
    const auth = getAuth();
    const loadingScreen = document.getElementById("loadingScreen");

    // Sabunta bayanan user daga Firebase idan localStorage bai da cikakken bayani
    async function getUserData(userId) {
        console.log("Checking localStorage...");
        let localData = localStorage.getItem(`user_${userId}`);
        let userData;

        if (localData) {
            userData = JSON.parse(localData);
            console.log("User data loaded from localStorage:", userData);
        }

        console.log("Fetching latest data from Firebase...");
        const userRef = ref(db, `users/${userId}`);
        const snapshot = await get(userRef);

        if (snapshot.exists()) {
            console.log("User data updated from Firebase.");
            userData = snapshot.val();
            localStorage.setItem(`user_${userId}`, JSON.stringify(userData));
        }

        return userData;
    }

    // Gyaran handleInvestmentLogic
    async function handleInvestmentLogic(userId, userData) {
        if (!userData) {
            alert("User data not found.");
            window.location.href = "register.html";
            return;
        }

        const investmentData = parseFloat(userData.investment) || 0;
        if (investmentData < 3500) {
            alert("You need to make a valid investment to proceed.");
            window.location.href = "dashboard.html";
            return;
        }

        const currentTime = new Date();
        const tsohonUser = userData.tsohonUser || "false";
        const investmentTime = new Date(userData.investmentTime || currentTime.toISOString());
        const daysElapsed = Math.floor((currentTime - investmentTime) / (1000 * 60 * 60 * 24));

        const investmentMap = [
            { amount: 3500, dailyUpgrade: 160, referralBonus: 250, referralUpgrade: 12.8, days: 35 },
            { amount: 8000, dailyUpgrade: 300, referralBonus: 600, referralUpgrade: 28, days: 35 },
            { amount: 15000, dailyUpgrade: 700, referralBonus: 950, referralUpgrade: 124.8, days: 36 },
            { amount: 35000, dailyUpgrade: 1100, referralBonus: 2100, referralUpgrade: 124.8, days: 37 },
            { amount: 70000, dailyUpgrade: 2800, referralBonus: 4300, referralUpgrade: 245.6, days: 39 },
            { amount: 140000, dailyUpgrade: 5240, referralBonus: 9200, referralUpgrade: 499.2, days: 40 },
            { amount: 280000, dailyUpgrade: 11300, referralBonus: 20400, referralUpgrade: 998.4, days: 42 },
        ];

        const matchedPlan = investmentMap.find(plan => investmentData >= plan.amount);
        if (!matchedPlan) {
            alert("You need to make a valid investment to proceed.");
            window.location.href = "dashboard.html";
            return;
        }

        const updates = {
            lastUpdate: currentTime.toISOString(),
            tsohonUser: tsohonUser === "false" ? "yes" : tsohonUser
        };

        if (daysElapsed >= matchedPlan.days) {
            updates.investment = 0;
            updates.dailyUpgrade = 0;
            updates.investmentTime = null;
        }

        if (!userData.dailyUpgrade || userData.dailyUpgrade !== matchedPlan.dailyUpgrade) {
            updates.dailyUpgrade = matchedPlan.dailyUpgrade;
        }

        if (!userData.investmentTime) {
            updates.investmentTime = currentTime.toISOString();
        }

        if (tsohonUser === "false" && investmentData >= 3500) {
            updates.userBalance = (userData.userBalance || 0) + 500;
        }

        await update(ref(db, `users/${userId}`), updates);
        localStorage.setItem(`user_${userId}`, JSON.stringify(updates)); // Sabunta localStorage

        if (daysElapsed >= matchedPlan.days) {
            alert("ðŸ‘‹ Hello, Renew Your Investment Now!");
        }

        setTimeout(() => {
            window.location.href = "dashboard.html";
        }, 200);
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userId = user.uid;
            loadingScreen.style.display = "flex"; // Nuna loading
            const userData = await getUserData(userId);
            await handleInvestmentLogic(userId, userData);
            loadingScreen.style.display = "none"; // Cire loading
        } else {
            alert("Please register first.");
            window.location.href = "register.html";
        }
    });

</script>
</body>
</html>
